<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Push-up Counter Web App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- MediaPipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #0f0f0f;
  color: #fff;
}

header {
  text-align: center;
  padding: 12px;
  font-size: 26px;
  font-weight: bold;
}

#description {
  text-align: center;
  font-size: 14px;
  color: #ccc;
  padding: 0 12px 10px;
  line-height: 1.6;
}

#app {
  display: flex;
  flex-direction: column;
  align-items: center;
}

#controls {
  text-align: center;
  margin: 10px;
}

input, button {
  font-size: 16px;
  padding: 8px 12px;
  margin: 5px;
}

canvas {
  width: 100%;
  max-width: 600px;
  transform: scaleX(-1);
}

#counter {
  font-size: 56px;
  margin-top: 10px;
  transition: transform 0.2s;
  text-align: center;
}

.animate {
  transform: scale(1.3);
}

#status {
  font-size: 20px;
  margin-top: 5px;
  color: #6cf;
  text-align: center;
}

/* ===== 横向き最適化 ===== */
@media (orientation: landscape) {
  #app {
    flex-direction: row;
    height: calc(100vh - 120px);
  }

  canvas {
    max-width: none;
    width: 65vw;
    height: auto;
  }

  #sidePanel {
    width: 35vw;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  #controls {
    margin: 0;
  }

  #counter {
    font-size: 72px;
  }
}
</style>
</head>

<body>

<header>Push-up Counter</header>

<div id="description">
  腕立て伏せ自動回数カウンターです。<br>
  カメラで姿勢を認識し、腕立て伏せの回数をカウントします。
  カメラの前で、顔,肩,肘が映る状態で腕立て伏せを行ってください。<br>
  START:計測開始  PAUSE:一時停止  RESUME:再開  RESET:リセット<br>
  ※カメラ映像は端末内で処理され、外部に送信・保存されることはありません。<br>
</div>

<div id="app">

  <video id="video" playsinline style="display:none;"></video>
  <canvas id="canvas"></canvas>

  <div id="sidePanel">
    <div id="controls">
      目標回数：
      <input type="number" id="target" value="10" min="1"><br>
      <button id="startBtn">START</button>
      <button id="pauseBtn" disabled>PAUSE</button>
      <button id="resetBtn">RESET</button>
    </div>

    <div id="counter">0</div>
    <div id="status">Ready</div>
  </div>

</div>

<audio id="countSound" src="count.mp3"></audio>
<audio id="goalSound" src="goal.mp3"></audio>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const counterEl = document.getElementById("counter");
const statusEl = document.getElementById("status");

const countSound = document.getElementById("countSound");
const goalSound = document.getElementById("goalSound");

const startBtn = document.getElementById("startBtn");
const pauseBtn = document.getElementById("pauseBtn");
const resetBtn = document.getElementById("resetBtn");

let count = 0;
let target = 10;
let position = null;
let running = false;
let paused = false;

const pose = new Pose({
  locateFile: file =>
    `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
});

pose.setOptions({
  modelComplexity: 1,
  smoothLandmarks: true,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.7
});

pose.onResults(onResults);

const camera = new Camera(video, {
  onFrame: async () => {
    if (running && !paused) {
      await pose.send({ image: video });
    }
  },
  width: 640,
  height: 480
});

startBtn.onclick = () => {
  count = 0;
  counterEl.textContent = count;
  target = Number(document.getElementById("target").value);
  position = null;
  running = true;
  paused = false;
  pauseBtn.textContent = "PAUSE";
  pauseBtn.disabled = false;
  statusEl.textContent = "Running";
  camera.start();
};

pauseBtn.onclick = () => {
  paused = !paused;
  pauseBtn.textContent = paused ? "RESUME" : "PAUSE";
  statusEl.textContent = paused ? "Paused" : "Running";
};

resetBtn.onclick = () => {
  running = false;
  paused = false;
  count = 0;
  position = null;
  counterEl.textContent = "0";
  statusEl.textContent = "Reset / Ready";
  pauseBtn.textContent = "PAUSE";
  pauseBtn.disabled = true;
};

function onResults(results) {
  canvas.width = results.image.width;
  canvas.height = results.image.height;

  ctx.save();
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

  if (results.poseLandmarks) {
    drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS,
      { color: "#00ff88", lineWidth: 2 });
    drawLandmarks(ctx, results.poseLandmarks,
      { color: "#ff4444", lineWidth: 2 });

    const lm = results.poseLandmarks;
    const shoulderY = (lm[11].y + lm[12].y) / 2;
    const elbowY = (lm[13].y + lm[14].y) / 2;

    if (shoulderY > elbowY) position = "down";
    if (shoulderY < elbowY && position === "down") {
      position = "up";
      incrementCount();
    }
  }
  ctx.restore();
}

function incrementCount() {
  count++;
  counterEl.textContent = count;
  counterEl.classList.add("animate");
  countSound.currentTime = 0;
  countSound.play();

  setTimeout(() => counterEl.classList.remove("animate"), 200);

  if (count >= target) {
    statusEl.textContent = "YOU DID IT!!";
    goalSound.play();
    running = false;
    pauseBtn.disabled = true;
  }
}
</script>

</body>
</html>
